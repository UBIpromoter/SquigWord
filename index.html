<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SquigWord</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0d0d0f;
            --card: #161619;
            --input: #1e1e22;
            --text: #ffffff;
            --dim: #9ca3af;
            --muted: #6b7280;
            --accent: #a855f7;
            --glow: rgba(168, 85, 247, 0.2);
            --border: rgba(255, 255, 255, 0.08);
        }
        .light-mode {
            --bg: #f5f5f7;
            --card: #ffffff;
            --input: #f0f0f2;
            --text: #1a1a1a;
            --dim: #4b5563;
            --muted: #6b7280;
            --accent: #7c3aed;
            --glow: rgba(124, 58, 237, 0.15);
            --border: rgba(0, 0, 0, 0.08);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { overflow-x: hidden; }
        body {
            font-family: 'Space Grotesk', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .app {
            max-width: 800px;
            width: 100%;
            margin: 0 auto;
            padding: 24px 16px 12px;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .canvas-row {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
            align-items: center;
        }
        .canvas-wrap {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 6px;
            position: relative;
            flex: 5;
            min-width: 0;
        }
        .ref-wrap {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 6px;
            position: relative;
            flex: 3;
            min-width: 0;
        }
        canvas {
            width: 100%;
            display: block;
            border-radius: 6px;
            cursor: pointer;
        }
        .panel {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px 20px;
            flex-shrink: 0;
        }
        .field { margin-bottom: 14px; }
        .field:last-child { margin-bottom: 0; }
        .field-label {
            display: block;
            font-size: 11px;
            font-weight: 600;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        .field-row {
            display: flex;
            gap: 16px;
            margin-bottom: 14px;
        }
        .flex-grow { flex: 1; min-width: 0; }
        .input-group {
            display: flex;
            gap: 6px;
            align-items: center;
        }
        input[type="text"], input[type="number"] {
            background: var(--input);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 10px 12px;
            font-size: 16px;
            font-family: inherit;
            color: var(--text);
            outline: none;
            transition: border 0.15s;
        }
        input:focus { border-color: var(--accent); }
        input[type="text"] { flex: 1; min-width: 0; }
        input[type="number"] {
            width: 100px;
            font-family: 'JetBrains Mono', monospace;
            text-align: center;
        }
        .btn-row {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        .btn {
            padding: 8px 14px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            border: 1px solid var(--border);
            background: var(--input);
            color: var(--dim);
            transition: all 0.12s;
            white-space: nowrap;
        }
        .btn:hover { background: var(--bg); color: var(--text); }
        .btn.active {
            background: rgba(168, 85, 247, 0.35);
            border-color: rgba(168, 85, 247, 0.5);
            color: #e9d5ff;
        }
        .light-mode .btn.active {
            background: rgba(124, 58, 237, 0.2);
            border-color: rgba(124, 58, 237, 0.4);
            color: #6d28d9;
        }
        .btn.resolved {
            border-color: rgba(96, 165, 250, 0.6);
            color: var(--text);
        }
        .light-mode .btn.resolved {
            border-color: rgba(59, 130, 246, 0.5);
            color: var(--text);
        }
        .btn.hyper-btn { font-size: 12px; letter-spacing: 0.5px; }
        .btn.hyper-btn.active {
            background: linear-gradient(135deg, rgba(255,80,80,0.3), rgba(255,200,50,0.3), rgba(80,200,255,0.3));
            border-color: rgba(255,255,255,0.25);
            color: #fff;
        }
        .light-mode .btn.hyper-btn.active {
            background: linear-gradient(135deg, rgba(255,80,80,0.2), rgba(255,200,50,0.2), rgba(80,200,255,0.2));
            border-color: rgba(0,0,0,0.15);
            color: #1a1a1a;
        }
        .icon-btn {
            width: 38px;
            height: 38px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--card);
            color: var(--muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.15s;
        }
        .icon-btn:hover {
            background: var(--glow);
            border-color: var(--accent);
            color: var(--text);
        }
        .action-row {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
            align-items: center;
            justify-content: space-between;
        }
        .hint {
            text-align: center;
            font-size: 12px;
            color: var(--muted);
            padding: 8px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .footer {
            text-align: center;
            padding: 8px;
            font-size: 12px;
            color: var(--muted);
            flex-shrink: 0;
            margin-top: auto;
        }
        .credit { color: var(--dim); }
        .icon-btn.playing { background: var(--glow); border-color: var(--accent); color: var(--accent); }
        .speed-slider { width: 80px; height: 4px; accent-color: var(--accent); display: none; }
        .speed-slider.visible { display: block; }
    </style>
</head>
<body>
    <div class="app">
        <div class="canvas-row">
            <div class="canvas-wrap"><canvas id="canvas" width="1400" height="600"></canvas></div>
            <div class="ref-wrap"><canvas id="refCanvas" width="900" height="600"></canvas></div>
        </div>
        <div class="panel">
            <div class="field-row">
                <div class="field flex-grow">
                    <label class="field-label">Text</label>
                    <div class="input-group">
                        <input type="text" id="textInput" value="Squiggles" maxlength="40" spellcheck="false">
                        <button class="icon-btn" id="randWordBtn" title="Random word">&#8635;</button>
                    </div>
                </div>
                <div class="field">
                    <label class="field-label">Seed</label>
                    <div class="input-group">
                        <input type="number" id="seedInput" value="42">
                        <button class="icon-btn" id="randSeedBtn" title="Random seed">&#8635;</button>
                    </div>
                </div>
            </div>
            <div class="field">
                <label class="field-label">Type</label>
                <div class="btn-row" id="typeBtns"></div>
            </div>
            <div class="field">
                <label class="field-label">Font</label>
                <div class="btn-row" id="fontBtns"></div>
            </div>
            <div class="action-row">
                <button class="icon-btn" id="modeToggle" title="Toggle light/dark">&#9728;</button>
                <div style="display:flex;gap:8px;align-items:center">
                    <button class="icon-btn" id="animateBtn" title="Draw animation">&#9654;</button>
                    <input type="range" class="speed-slider" id="drawSpeedSlider" min="1" max="20" value="3" title="Draw speed">
                    <button class="icon-btn" id="downloadBtn" title="Download PNG">&#8595;</button>
                    <button class="icon-btn" id="downloadTransBtn" title="Download transparent PNG" style="font-size:12px;letter-spacing:-2px">&#8595;&#9723;</button>
                </div>
            </div>
        </div>
        <div class="hint" id="hint">space bg &middot; &uarr;&darr; speed &middot; &#8679; max/min</div>
        <footer class="footer">SquigWord &middot; inspired by <span class="credit">snowfro</span></footer>
    </div>

    <script src="squigword-engine.js"></script>
    <script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const refCanvas = document.getElementById('refCanvas');
    const refCtx = refCanvas.getContext('2d');

    const state = {
        text: 'Squiggles',
        seed: 42,
        forceType: 'Auto',
        fontStyle: 'Allure',
        bgIndex: 7,
        darkMode: true,
        forceHyper: null,  // seed decides
        // Color cycling
        colorCycling: false,
        cycleSpeed: 0.08,
        colorOffset: 0,
        cycleAnimFrame: null,
        // Draw animation
        drawAnimating: false,
        drawProgress: 0,
        drawSpeed: 3,
    };

    function buildConfig() {
        // Derive shape from the squiggle's actual wave properties
        const shape = SquigWord.deriveShapeFromSquiggle(state.seed, state.fontStyle);
        return {
            seed: state.seed,
            fontStyle: state.fontStyle,
            rotation: shape.rotation,
            slant: shape.slant,
            loopWidth: shape.loopWidth,
            loopHeight: shape.loopHeight,
            colorOffset: state.colorOffset
        };
    }

    let lastTraits = null;

    function render() {
        const width = canvas.width;
        const height = canvas.height;

        ctx.fillStyle = SquigWord.BACKGROUNDS[state.bgIndex];
        ctx.fillRect(0, 0, width, height);

        const traits = SquigWord.resolveTraits(state.seed, state.forceType, state.forceHyper);
        lastTraits = traits;

        if (!state.text.trim()) return;

        const config = buildConfig();
        const { particles } = SquigWord.computeDrawOps(
            state.text, width, height, traits.type, traits.spread, config
        );
        SquigWord.drawParticles(ctx, particles);

        SquigWord.renderSnowfro(refCtx, refCanvas.width, refCanvas.height, {
            seed: state.seed,
            forceType: state.forceType,
            forceHyper: state.forceHyper,
            bgIndex: state.bgIndex,
            colorOffset: state.colorOffset
        });

        updateButtons();
    }

    // Color cycling
    function startColorCycling() {
        if (state.drawAnimating) stopDrawAnimation();
        state.colorCycling = true;
        showHint();
        colorCycleLoop();
    }

    function stopColorCycling() {
        state.colorCycling = false;
        if (state.cycleAnimFrame) {
            cancelAnimationFrame(state.cycleAnimFrame);
            state.cycleAnimFrame = null;
        }
    }

    function colorCycleLoop() {
        if (!state.colorCycling) return;
        state.colorOffset += state.cycleSpeed;
        render();
        state.cycleAnimFrame = requestAnimationFrame(colorCycleLoop);
    }

    // Draw animation
    let cachedParticles = null;

    function startDrawAnimation() {
        if (state.drawAnimating) { stopDrawAnimation(); return; }
        if (state.colorCycling) stopColorCycling();
        state.drawAnimating = true;
        state.drawProgress = 0;
        document.getElementById('animateBtn').textContent = '\u23F9';
        document.getElementById('animateBtn').classList.add('playing');
        document.getElementById('drawSpeedSlider').classList.add('visible');

        const traits = SquigWord.resolveTraits(state.seed, state.forceType, state.forceHyper);
        const config = buildConfig();
        const result = SquigWord.computeDrawOps(state.text, canvas.width, canvas.height, traits.type, traits.spread, config);
        cachedParticles = result.particles;
        animateDrawing();
    }

    function stopDrawAnimation() {
        state.drawAnimating = false;
        document.getElementById('animateBtn').textContent = '\u25B6';
        document.getElementById('animateBtn').classList.remove('playing');
        document.getElementById('drawSpeedSlider').classList.remove('visible');
        render();
    }

    function animateDrawing() {
        if (!state.drawAnimating || !cachedParticles || cachedParticles.length === 0) {
            stopDrawAnimation(); return;
        }
        const total = cachedParticles.length;
        const toDraw = Math.min(Math.floor(state.drawProgress), total);
        ctx.fillStyle = SquigWord.BACKGROUNDS[state.bgIndex];
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        SquigWord.drawParticles(ctx, cachedParticles.slice(0, toDraw));
        state.drawProgress += state.drawSpeed * 3;
        if (state.drawProgress >= total) { stopDrawAnimation(); }
        else { requestAnimationFrame(animateDrawing); }
    }

    // Hint text
    let hintTimeout = null;
    function showHint() {
        const hint = document.getElementById('hint');
        hint.style.opacity = '1';
        clearTimeout(hintTimeout);
        hintTimeout = setTimeout(() => { hint.style.opacity = '0'; }, 3000);
    }

    function downloadPNG(transparent) {
        const link = document.createElement('a');
        if (transparent) {
            // Render to offscreen canvas with no background
            const offCanvas = document.createElement('canvas');
            offCanvas.width = canvas.width;
            offCanvas.height = canvas.height;
            const offCtx = offCanvas.getContext('2d');
            const traits = SquigWord.resolveTraits(state.seed, state.forceType, state.forceHyper);
            const config = buildConfig();
            const result = SquigWord.computeDrawOps(state.text, canvas.width, canvas.height, traits.type, traits.spread, config);
            SquigWord.drawParticles(offCtx, result.particles);
            link.download = `squigword-${state.text}-${state.seed}-transparent.png`;
            link.href = offCanvas.toDataURL('image/png');
        } else {
            link.download = `squigword-${state.text}-${state.seed}.png`;
            link.href = canvas.toDataURL('image/png');
        }
        link.click();
    }

    function toggleDarkMode() {
        state.darkMode = !state.darkMode;
        document.body.classList.toggle('light-mode', !state.darkMode);
        document.getElementById('modeToggle').textContent = state.darkMode ? '\u2600' : '\u263E';
        state.bgIndex = state.darkMode ? 7 : 0;
        render();
    }

    function updateButtons() {
        const resolvedType = lastTraits ? lastTraits.type : null;
        document.querySelectorAll('#typeBtns .btn:not(.hyper-btn)').forEach(btn => {
            const name = btn.textContent;
            btn.classList.toggle('active', name === state.forceType);
            // Subtle highlight on the resolved type when Auto is selected
            btn.classList.toggle('resolved', state.forceType === 'Auto' && name === resolvedType);
        });
        document.querySelectorAll('#fontBtns .btn').forEach(btn => {
            btn.classList.toggle('active', btn.textContent === state.fontStyle);
        });
        // Hyper toggle
        const hyperBtn = document.getElementById('hyperBtn');
        if (hyperBtn) {
            const isHyper = state.forceHyper === true || (state.forceHyper === null && lastTraits && lastTraits.hyperRainbow);
            hyperBtn.classList.toggle('active', isHyper);
        }
    }

    function setup() {
        // Type buttons
        const typeBtns = document.getElementById('typeBtns');
        SquigWord.TYPES.forEach(t => {
            const btn = document.createElement('button');
            btn.className = 'btn';
            btn.textContent = t;
            btn.onclick = () => { state.forceType = t; updateButtons(); render(); };
            typeBtns.appendChild(btn);
        });

        // Hyper toggle (overlaps with any type)
        const hyperBtn = document.createElement('button');
        hyperBtn.className = 'btn hyper-btn';
        hyperBtn.id = 'hyperBtn';
        hyperBtn.textContent = 'Hyper';
        hyperBtn.onclick = () => {
            if (state.forceHyper === null) state.forceHyper = true;
            else if (state.forceHyper === true) state.forceHyper = false;
            else state.forceHyper = null;
            updateButtons();
            render();
        };
        typeBtns.appendChild(hyperBtn);

        // Font buttons
        const fontBtns = document.getElementById('fontBtns');
        SquigWord.FONT_NAMES.forEach(f => {
            const btn = document.createElement('button');
            btn.className = 'btn';
            btn.textContent = f;
            btn.onclick = () => { state.fontStyle = f; updateButtons(); render(); };
            fontBtns.appendChild(btn);
        });

        // Select all on focus for text inputs
        for (const id of ['textInput', 'seedInput']) {
            document.getElementById(id).addEventListener('focus', (e) => e.target.select());
        }

        // Text input
        document.getElementById('textInput').addEventListener('input', (e) => {
            state.text = e.target.value;
            render();
        });

        // Seed input
        document.getElementById('seedInput').addEventListener('input', (e) => {
            state.seed = parseInt(e.target.value) || 0;
            render();
        });

        // Random word
        const words = [
            'Squiggles','Wiggly','Jiggly','Groovy','Loopy','Balloon','Jelly','Giggles','Wobbly','Bubbles',
            'Noodle','Zigzag','Twisty','Curly','Swirly','Bouncy','Squishy','Fuzzy','Breezy','Snappy',
            'Mellow','Ripple','Shimmer','Flutter','Groove','Jumble','Tangle','Doodle','Sprinkle','Twirl',
            'Wavy','Floppy','Slinky','Bubbly','Zappy','Cosmic','Dreamy','Funky','Goofy','Jazzy',
            'Quirky','Peppy','Zippy','Wacky','Dizzy','Glimmer','Sparkle','Wobble','Squish','Jiggle',
            'Hello World','Stay Groovy','Good Vibes','Keep it Wavy','Dream Big',
            'Art is Fun','Go With the Flow','Just Vibes','On Chain Forever'
        ];
        document.getElementById('randWordBtn').addEventListener('click', () => {
            state.text = words[Math.floor(Math.random() * words.length)];
            state.seed = Math.floor(Math.random() * 100000);
            document.getElementById('textInput').value = state.text;
            document.getElementById('seedInput').value = state.seed;
            render();
        });

        // Random seed
        document.getElementById('randSeedBtn').addEventListener('click', () => {
            state.seed = Math.floor(Math.random() * 100000);
            document.getElementById('seedInput').value = state.seed;
            render();
        });

        // Canvas click -> color cycling
        canvas.addEventListener('click', () => {
            if (state.colorCycling) stopColorCycling();
            else startColorCycling();
        });
        refCanvas.addEventListener('click', () => {
            if (state.colorCycling) stopColorCycling();
            else startColorCycling();
        });

        // Keyboard
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT') return;
            if (e.code === 'Space') {
                e.preventDefault();
                state.bgIndex = state.bgIndex === 7 ? 0 : 7;
                render();
            } else if (e.code === 'ArrowUp') {
                e.preventDefault();
                state.cycleSpeed = e.shiftKey ? 1.5 : Math.min(state.cycleSpeed + 0.02, 1.5);
            } else if (e.code === 'ArrowDown') {
                e.preventDefault();
                state.cycleSpeed = e.shiftKey ? 0.02 : Math.max(state.cycleSpeed - 0.02, 0.02);
            }
        });

        // Mode toggle, animate, download
        document.getElementById('modeToggle').addEventListener('click', toggleDarkMode);
        document.getElementById('animateBtn').addEventListener('click', startDrawAnimation);
        document.getElementById('drawSpeedSlider').addEventListener('input', (e) => {
            state.drawSpeed = parseInt(e.target.value);
        });
        document.getElementById('downloadBtn').addEventListener('click', () => downloadPNG(false));
        document.getElementById('downloadTransBtn').addEventListener('click', () => downloadPNG(true));

        updateButtons();
        render();
    }

    setup();
    </script>
</body>
</html>
